name: Build IDA Plugin Windows DLL

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout Plugin Code
        uses: actions/checkout@v4

      - name: Checkout IDA SDK
        uses: actions/checkout@v4
        with:
          repository: shefben/ida_sdk_91
          path: idasdk9

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            make
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-tools
            sed

      # [核心修复]
      # 1. 替换 g++ 并加上 Windows 宏
      # 2. 移除 -fPIC
      # 3. 使用更通用的正则，将 ida.lib 追加到链接命令的末尾
      - name: Patch Makefile for Windows
        run: |
          # 1. 修改编译器，增加 -D__NT__ -D__X64__ (Windows 64位环境宏)
          sed -i 's|/usr/bin/clang++|g++ -D__NT__ -D__X64__|g' Makefile
          
          # 2. 移除 Linux 专用标志
          sed -i 's|-fPIC||g' Makefile

          # 3. [关键] 在包含 "-o" 的行末尾，追加 ida.lib 的路径
          # 这样无论 Makefile 里的目标文件名是什么，都会把库文件加到命令最后，确保链接器能读到。
          sed -i '/-o /s/$/ idasdk9\/lib\/x64_win_vc_64\/ida.lib/' Makefile

          # 4. 打印修改后的 Makefile，方便在 Actions 日志里检查是否替换成功
          echo "=== Debug: Patched Makefile Content ==="
          cat Makefile

      - name: Build Plugin
        run: make

      - name: Rename and Move Output
        run: |
          # 检查并重命名输出文件
          cp bin/class_informer_gcc.so class_informer_gcc.dll || cp bin/class_informer_gcc.dll class_informer_gcc.dll || echo "Warning: File not found in bin/"

      - name: Verify DLL
        run: ls -l class_informer_gcc.dll

      - name: Upload DLL Artifact
        uses: actions/upload-artifact@v4
        with:
          name: class_informer_gcc_plugin_win
          path: class_informer_gcc.dll
          if-no-files-found: error
