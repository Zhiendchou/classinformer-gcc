name: Build IDA Plugin Windows DLL

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout Plugin Code
        uses: actions/checkout@v4

      - name: Checkout IDA SDK
        uses: actions/checkout@v4
        with:
          repository: shefben/ida_sdk_91
          path: idasdk9

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            make
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-tools
            sed

      # [关键修复] 修改 Makefile 中的硬编码路径
      # 原 Makefile 写死了 /usr/bin/clang++，我们把它替换成 g++
      - name: Patch Makefile
        run: |
          sed -i 's|/usr/bin/clang++|g++|g' Makefile
          echo "Makefile patched successfully."
          # 打印一下确认修改结果 (可选)
          head -n 20 Makefile

      - name: Build Plugin
        run: make

      # 将生成的 .so (MinGW 生成的其实是 DLL) 重命名为 .dll
      - name: Rename and Move Output
        run: |
          cp bin/class_informer_gcc.so class_informer_gcc.dll || cp bin/class_informer_gcc.dll class_informer_gcc.dll

      - name: Upload DLL Artifact
        uses: actions/upload-artifact@v4
        with:
          name: class_informer_gcc_plugin_win
          path: class_informer_gcc.dll
          if-no-files-found: error
