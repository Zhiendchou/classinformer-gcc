name: Build IDA Plugin Windows DLL

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout Plugin Code
        uses: actions/checkout@v4

      - name: Checkout IDA SDK
        uses: actions/checkout@v4
        with:
          repository: shefben/ida_sdk_91
          path: idasdk9

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            make
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-tools
            sed

      # [关键修复]
      # 1. 替换编译器为 g++，并加上 Windows/64位 宏定义
      # 2. 移除 Linux 专用的 -fPIC 参数
      # 3. [新] 在链接命令的末尾加上 ida.lib 的路径
      - name: Patch Makefile for Windows
        run: |
          # 1. 修正编译器和宏定义
          sed -i 's|/usr/bin/clang++|g++ -D__NT__ -D__X64__|g' Makefile
          
          # 2. 移除 -fPIC
          sed -i 's|-fPIC||g' Makefile

          # 3. 注入链接库 (ida.lib)
          # 原理：找到输出指令 "-o bin/class_informer_gcc.so"，在它后面追加 ida.lib 的路径
          # 注意：MinGW 可以直接链接 MSVC 格式的 .lib 文件
          sed -i 's|-o bin/class_informer_gcc.so|-o bin/class_informer_gcc.so idasdk9/lib/x64_win_vc_64/ida.lib|g' Makefile

          # 打印 Makefile 检查修改是否生效
          echo "=== Patched Makefile Content ==="
          cat Makefile

      - name: Build Plugin
        run: make

      - name: Rename and Move Output
        run: |
          # 尝试复制并重命名
          cp bin/class_informer_gcc.so class_informer_gcc.dll || cp bin/class_informer_gcc.dll class_informer_gcc.dll || echo "Output file not found"

      - name: Verify DLL
        run: ls -l class_informer_gcc.dll

      - name: Upload DLL Artifact
        uses: actions/upload-artifact@v4
        with:
          name: class_informer_gcc_plugin_win
          path: class_informer_gcc.dll
          if-no-files-found: error
