name: Build IDA Plugin Windows DLL

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout Plugin Code
        uses: actions/checkout@v4

      - name: Checkout IDA SDK
        uses: actions/checkout@v4
        with:
          repository: shefben/ida_sdk_91
          path: idasdk9

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            make
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-tools
            sed

      # [关键修复步骤]
      # 1. 将编译器替换为 g++
      # 2. 添加 Windows 平台宏: -D__NT__ -D__X64__
      # 3. 移除 -fPIC (Windows 不需要)
      # 4. 尝试修复链接库路径 (Windows 下需链接 ida.lib)
      - name: Patch Makefile for Windows
        run: |
          # 替换编译器并添加宏定义
          sed -i 's|/usr/bin/clang++|g++ -D__NT__ -D__X64__|g' Makefile
          
          # 移除 -fPIC 标志 (Linux 专用)
          sed -i 's|-fPIC||g' Makefile

          # 打印修改后的 Makefile 前几行以供检查
          echo "=== Patched Makefile ==="
          head -n 20 Makefile

      # 如果遇到链接错误 (Undefined reference to ...)，可能需要手动指定 ida.lib
      # 但通常 MinGW 可以通过 -L 指定路径。这里先尝试直接编译。
      - name: Build Plugin
        run: make

      - name: Rename and Move Output
        run: |
          # Makefile 默认输出在 bin/ 下，通常是 .so，我们需要 .dll
          cp bin/class_informer_gcc.so class_informer_gcc.dll || cp bin/class_informer_gcc.dll class_informer_gcc.dll || echo "File not found in bin/"

      - name: Verify DLL
        run: ls -l class_informer_gcc.dll

      - name: Upload DLL Artifact
        uses: actions/upload-artifact@v4
        with:
          name: class_informer_gcc_plugin_win
          path: class_informer_gcc.dll
          if-no-files-found: error
